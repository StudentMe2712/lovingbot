import random
from utils.ollama_api import query_ollama
from utils.bot_utils import send_message_with_image
from utils.ollama_mode import get_ollama_mode
# from utils.hf_image_client import generate_image

class DateModule:
    def __init__(self, db):
        self.db = db
        self.ideas = {
            "üè† –î–æ–º–∞—à–Ω–∏–µ": [
                "–ö—É–ª–∏–Ω–∞—Ä–Ω—ã–π –ø–æ–µ–¥–∏–Ω–æ–∫",
                "–î–æ–º–∞—à–Ω–∏–π –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä —Å –ø–æ–ø–∫–æ—Ä–Ω–æ–º",
                "–¢–∞–Ω—Ü—ã –ø–æ–¥ –ª—é–±–∏–º—ã–µ –ø–µ—Å–Ω–∏",
                "–§–æ—Ç–æ—Å–µ—Å—Å–∏—è –¥–æ–º–∞",
            ],
            "üåÜ –ì–æ—Ä–æ–¥—Å–∫–∏–µ": [
                "–ü—Ä–æ–≥—É–ª–∫–∞ –ø–æ –Ω–æ–≤–æ–º—É —Ä–∞–π–æ–Ω—É",
                "–ü–∏–∫–Ω–∏–∫ –≤ –ø–∞—Ä–∫–µ",
                "–ü–æ—Å–µ—â–µ–Ω–∏–µ –º—É–∑–µ—è/–≤—ã—Å—Ç–∞–≤–∫–∏",
                "–ö–∞—Ñ–µ —Å –Ω–µ–æ–±—ã—á–Ω–æ–π –∞—Ç–º–æ—Å—Ñ–µ—Ä–æ–π",
            ],
            "üéØ –ê–∫—Ç–∏–≤–Ω—ã–µ": [
                "–ë–æ—É–ª–∏–Ω–≥ –∏–ª–∏ –±–∏–ª—å—è—Ä–¥",
                "–ö–≤–µ—Å—Ç –∏–ª–∏ —ç—Å–∫–µ–π–ø-—Ä—É–º",
                "–ö–∞—Ç–∞–Ω–∏–µ –Ω–∞ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞—Ö",
                "–ú–∏–Ω–∏-–≥–æ–ª—å—Ñ",
            ],
            "üí´ –û—Å–æ–±–µ–Ω–Ω—ã–µ": [
                "–ù–∞–±–ª—é–¥–µ–Ω–∏–µ –∑–∞ –∑–≤–µ–∑–¥–∞–º–∏",
                "–†–∞—Å—Å–≤–µ—Ç –∏–ª–∏ –∑–∞–∫–∞—Ç –≤–º–µ—Å—Ç–µ",
                "–°–ø–æ–Ω—Ç–∞–Ω–Ω–∞—è –ø–æ–µ–∑–¥–∫–∞ –≤ —Å–æ—Å–µ–¥–Ω–∏–π –≥–æ—Ä–æ–¥",
            ],
        }

    async def send_important_date_reminder(self, update, context):
        # TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –≤–∞–∂–Ω–æ–π –¥–∞—Ç–µ
        await update.message.reply_text("–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –≤–∞–∂–Ω–æ–π –¥–∞—Ç–µ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç!")

    async def send_date_idea(self, update, context):
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–¥–µ–∏ —á–µ—Ä–µ–∑ LLM
        if context:
            mode, submode = get_ollama_mode(context)
        else:
            mode, submode = "general", "standard"
        prompt = f"–ü—Ä–µ–¥–ª–æ–∂–∏ —É–Ω–∏–∫–∞–ª—å–Ω—É—é –∏–¥–µ—é –¥–ª—è —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–≤–∏–¥–∞–Ω–∏—è –¥–ª—è –ø–∞—Ä—ã. –ö—Ä–∞—Ç–∫–æ –∏ –ø–æ-—Ä—É—Å—Å–∫–∏.\n–†–µ–∂–∏–º: {mode}\n–ü–æ–¥—Ä–µ–∂–∏–º: {submode}"
        result = await query_ollama(prompt)
        
        text_to_send = ""
        if result:
            text_to_send = f"üí° –ò–¥–µ—è –¥–ª—è —Å–≤–∏–¥–∞–Ω–∏—è: {result}"
        else:
            # Fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫
            category = random.choice(list(self.ideas.keys()))
            idea = random.choice(self.ideas[category])
            text_to_send = f"{category} –∏–¥–µ—è –¥–ª—è —Å–≤–∏–¥–∞–Ω–∏—è:\n{idea}"

        await send_message_with_image(
            update=update,
            context=context,
            text=text_to_send,
            image_prompt=f"romantic date idea: {result if result else idea}"
        ) 